{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"ELB stack",
   "Mappings":{
      "ELBAccountMap":{
         "us-east-1":{
            "ID":"127311923021"
         },
         "us-west-1":{
            "ID":"027434742980"
         },
         "us-west-2":{
            "ID":"797873946194"
         },
         "eu-west-1":{
            "ID":"156460612806"
         },
         "sa-east-1":{
            "ID":"507241528517"
         },
         "ap-southeast-1":{
            "ID":"114774131450"
         },
         "ap-southeast-2":{
            "ID":"783225319266"
         },
         "ap-northeast-1":{
            "ID":"582318560864"
         }
      }
   },
   "Parameters":{
      "SSLCertificateId":{
         "Description":"SSL certificate of ELB",
         "Type":"String"
      },
      "SubnetPublicA":{
         "Description":"ELB Subnets",
         "Type":"String"
      },
      "SubnetPublicB":{
         "Description":"ELB Subnets",
         "Type":"String"
      },
      "SecurityGroupId":{
         "Description":"ELB security groups",
         "Type":"String"
      },
      "S3LoggingBucketName":{
         "Description":"Access Logging Bucket",
         "Type":"String"
      }
   },
   "Resources":{
      "LoggingBucketPolicy":{
         "Type":"AWS::S3::BucketPolicy",
         "Properties":{
            "Bucket":{
               "Ref":"S3LoggingBucketName"
            },
            "PolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "s3:PutObject"
                     ],
                     "Effect":"Allow",
                     "Resource":{
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:s3:::",
                              {
                                 "Ref":"S3LoggingBucketName"
                              },
                              "/",
                              "*"
                           ]
                        ]
                     },
                     "Principal":{
                        "AWS":[
                           {
                              "Fn::FindInMap":[
                                 "ELBAccountMap",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 "ID"
                              ]
                           }
                        ]
                     }
                  }
               ]
            }
         }
      },
      "ElasticLoadBalancer":{
         "DependsOn":"LoggingBucketPolicy",
         "Properties":{
            "Subnets":[
               {
                  "Ref":"SubnetPublicA"
               },
               {
                  "Ref":"SubnetPublicB"
               }
            ],
            "SecurityGroups":[
               {
                  "Ref":"SecurityGroupId"
               }
            ],
            "AccessLoggingPolicy":{
               "EmitInterval":"5",
               "Enabled":"true",
               "S3BucketPrefix":{
                  "Fn::Join":[
                     "",
                     [
                        "test-load-balancer-logs"
                     ]
                  ]
               },
               "S3BucketName":{
                  "Ref":"S3LoggingBucketName"
               }
            },
            "HealthCheck":{
               "HealthyThreshold":"3",
               "Interval":"10",
               "Target":{
                  "Fn::Join":[
                     "",
                     [
                        "HTTP:",
                        "80",
                        "/"
                     ]
                  ]
               },
               "Timeout":"5",
               "UnhealthyThreshold":"5"
            },
            "Listeners":[
               {
                  "InstancePort":"80",
                  "LoadBalancerPort":"443",
                  "InstanceProtocol":"HTTPS",
                  "Protocol":"HTTPS",
                  "SSLCertificateId":{
                     "Ref":"SSLCertificateId"
                  }
               }
            ],
            "ConnectionDrainingPolicy":{
               "Enabled":"true",
               "Timeout":"100"
            }
         },
         "Type":"AWS::ElasticLoadBalancing::LoadBalancer"
      }
   },
   "Outputs":{
      "ElasticLoadBalancerName":{
         "Value":{
            "Ref":"ElasticLoadBalancer"
         }
      },
      "ElasticLoadBalancerDNSName":{
         "Value":{
            "Fn::GetAtt":[
               "ElasticLoadBalancer",
               "DNSName"
            ]
         }
      }
   }
}