{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Opsworks Stacks",
   "Parameters":{
      "SystemName":{
         "Default":"Jira Mediator Test",
         "Description":"System Name",
         "Type":"String"
      },
      "KeyPair":{
         "Description":"Key Pair Name for the instances",
         "Type":"String"
      },
      "AppURL":{
         "Description":"path of ROOT.tar.gz",
         "Type":"String"
      },
      "AppTag":{
         "Description":"OpsWorks tag name",
         "Type":"String"
      },
      "AWSAccessKey":{
         "Description":"AWS Access Key",
         "Type":"String"
      },
      "AWSSecretKey":{
         "Description":"AWS Secret Key",
         "NoEcho":"true",
         "Type":"String"
      },
      "IAMRole":{
         "Description":"IAM Role for EC2",
         "Type":"String"
      },
      "VPC":{
         "Description":"VPC",
         "Type":"String"
      },
      "SubnetPublicA":{
         "Description":"One of subnet in VPC",
         "Type":"String"
      },
      "SecurityGroupAppId":{
         "Description":"App security group",
         "Type":"String"
      },
      "ElasticLoadBalancerName":{
         "Description":"load balancer name",
         "Type":"String"
      },
      "JiraUsername":{
         "Description":"Jira rest username",
         "Type":"String"
      },
      "JiraPassword":{
         "Description":"Jira rest Password",
         "NoEcho":"true",
         "Type":"String"
      }
   },
   "Resources":{
      "CSStack":{
         "Type":"AWS::OpsWorks::Stack",
         "Properties":{
            "Name":{
               "Fn::Join":[
                  "-",
                  [
                     {
                        "Ref":"AppTag"
                     },
                     "web",
                     "app"
                  ]
               ]
            },
            "ServiceRoleArn":{
               "Fn::Join":[
                  "",
                  [
                     "arn:aws:iam::",
                     {
                        "Ref":"AWS::AccountId"
                     },
                     ":role/",
                     "aws-opsworks-service-role"
                  ]
               ]
            },
            "UseOpsworksSecurityGroups":"false",
            "UseCustomCookbooks":"true",
            "CustomCookbooksSource":{
               "Type":"git",
               "Url":"https://github.com/msfuko/opsworks-extended-cookbooks.git",
               "Revision":"prototype"
            },
            "ConfigurationManager":{
               "Name":"Chef",
               "Version":"11.10"
            },
            "ChefConfiguration":{
               "BerkshelfVersion":"3.1.3",
               "ManageBerkshelf":"true"
            },
            "CustomJson":{
               "deploy":{
                  "root":{
                     "environment_variables":{
                        "JIRA_USERNAME":{
                           "Ref":"JiraUsername"
                        },
                        "JIRA_PASSWORD":{
                           "Ref":"JiraPassword"
                        }
                     }
                  }
               },
               "opsworks":{
                  "instance":{
                     "hostname":{
                        "Fn::Join":[
                           "-",
                           [
                              {
                                 "Ref":"AppTag"
                              }
                           ]
                        ]
                     }
                  }
               }
            },
            "DefaultInstanceProfileArn":{
               "Fn::Join":[
                  "",
                  [
                     "arn:aws:iam::",
                     {
                        "Ref":"AWS::AccountId"
                     },
                     ":instance-profile/",
                     {
                        "Ref":"IAMRole"
                     }
                  ]
               ]
            },
            "VpcId":{
               "Ref":"VPC"
            },
            "DefaultSubnetId":{
               "Ref":"SubnetPublicA"
            },
            "DefaultSshKeyName":{
               "Ref":"KeyPair"
            }
         }
      },
      "AppLayer":{
         "Type":"AWS::OpsWorks::Layer",
         "DependsOn":[
            "csApp"
         ],
         "Properties":{
            "StackId":{
               "Ref":"CSStack"
            },
            "Type":"java-app",
            "Shortname":{
               "Fn::Join":[
                  "-",
                  [
                     {
                        "Ref":"AppTag"
                     },
                     "app"
                  ]
               ]
            },
            "EnableAutoHealing":"true",
            "AutoAssignElasticIps":"false",
            "AutoAssignPublicIps":"true",
            "CustomSecurityGroupIds":[
               {
                  "Ref":"SecurityGroupAppId"
               }
            ],
            "Name":"JiraMediatorAppServer",
            "CustomRecipes":{
               "Deploy":[
                  "deploy::java"
               ]
            }
         }
      },
      "AppELBAttachment":{
         "Type":"AWS::OpsWorks::ElasticLoadBalancerAttachment",
         "Properties":{
            "ElasticLoadBalancerName":{
               "Ref":"ElasticLoadBalancerName"
            },
            "LayerId":{
               "Ref":"AppLayer"
            }
         }
      },
      "csApp":{
         "Type":"AWS::OpsWorks::App",
         "Properties":{
            "StackId":{
               "Ref":"CSStack"
            },
            "Type":"java",
            "Name":"ROOT",
            "Shortname":"root",
            "EnableSsl":"false",
            "AppSource":{
               "Type":"s3",
               "Username":{
                  "Ref":"AWSAccessKey"
               },
               "Password":{
                  "Ref":"AWSSecretKey"
               },
               "Url":{
                  "Ref":"AppURL"
               }
            }
         }
      }
   },
   "Outputs":{
      "AppLayer":{
         "Value":{
            "Ref":"AppLayer"
         }
      },
      "CSStack":{
         "Value":{
            "Ref":"CSStack"
         }
      }
   }
}